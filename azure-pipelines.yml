trigger:
  - master
  
pool:
    vmImage: ubuntu-latest

stages:
- stage: Terraform_Plan
  jobs:
  - job: build_job
    steps:       
      - script: |
          sudo apt-get update
          pip install --upgrade databricks-cli
         # sudo apt-get install software-properties-common
         # sudo apt-get install python3.9
         # sudo apt install python3-pip 
         # pip install checkov
        displayName: 'Requirements'
        workingDirectory: $(System.DefaultWorkingDirectory)

      - task: AzureKeyVault@2
        inputs:
          azureSubscription: "service-connect-vault-access"
          KeyVaultName: 'kv-razi'
          SecretsFilter: 'client-id, client-secret, tenant-id, tfstate-storage-key'
        displayName: 'Azure Key Vault Secrets'

      - script: |
          az login --service-principal -u $(client-id) -p $(client-secret) --tenant $(tenant-id)
        displayName: 'Azure authenticate'
        workingDirectory: $(System.DefaultWorkingDirectory)/

      - script: |
          terraform init -backend-config="access_key=$(tfstate-storage-key)"
        displayName: 'Terraform initialization'
     
      - script: |          
          terraform fmt
          terraform validate
          terraform plan -out=tfplan
        displayName: 'Terraform Validate'
        workingDirectory: $(System.DefaultWorkingDirectory)/

      - script: |
          if [ "$(Builda.Reason)" == "PullRequest" ] && [ "$(Build.ReasonCode)" -eq "2" ]; then
            terraform apply -auto-approve tfplan
          else
            echo "Skipping terraform apply because PR is not yet accepted"
        displayName: 'Terraform run on PR'
        workingDirectory: $(System.DefaultWorkingDirectory)/